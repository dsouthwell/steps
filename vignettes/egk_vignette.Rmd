---
title: "A Eastern Grey Kangaroo population simulation example"
author: "Casey Visintin"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    fig_width: 7
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, message = FALSE, echo = FALSE}
library(steps)
library(raster)
```

Below is an example using the eastern grey kangaroo (EGK) - a large marsupial native to Australia.  

First we setup the stage based transition matricies. The first matrix represents survival and fecundity life-stage transition probabilities for kangaroos. The second matrix describes the uncertainty around the transition probabilities and is used to simulate environmental stochasticity - zeros indicate no uncertainty. Note, there are three life-stages and the matrices are symmetrical in their row and column numbers. Also, names are added to the columns and rows to identify the different life-stages of the kangaroo. These two objects are available in the steps package ("egk_mat" and "egk_mat_stoch").

```{r, message = FALSE}

egk_mat <- matrix(c(0.00,0.00,1.00,
                    0.50,0.00,0.00,
                    0.00,0.85,0.85),
                  nrow = 3,
                  ncol = 3,
                  byrow = TRUE)
colnames(egk_mat) <- rownames(egk_mat) <- c('juvenile','subadult','adult')

egk_mat_stoch <- matrix(c(0.00,0.00,0.20,
                          0.05,0.00,0.00,
                          0.00,0.10,0.05),
                  nrow = 3,
                  ncol = 3,
                  byrow = TRUE)
colnames(egk_mat_stoch) <- rownames(egk_mat_stoch) <- c('juvenile','subadult','adult')

```    

Read in spatial inputs to be used for the simulations. A 17.5km x 18km spatial grid with a resolution of 500m2 is used as the landscape for the meta-population of kangaroos. Each cell represents a patch that kangaroos can move between - dependent upon its unique attributes. 

A habitat suitability layer describes the relative likelihood of the species occurring in each cell and should contain values between 0 (not inhabited) and 1 (inhabited). If the original values are not in this range, they should be rescaled accordingly. This example spatial data is available in the steps package ("egk_hab"), however, any raster can be used in its place.

```{r, message = FALSE, fig.align="center"}
egk_hab

par(mar=c(0,0,0,0), oma=c(0,0,0,0))
plot(egk_hab, box = FALSE, axes = FALSE)
```

The carrying capacity layer describes the total number of species that may occur in each cell and contains either zeros or positive integer values. This example spatial data is available in the steps package ("egk_k"), however, any raster can be used in its place.

```{r, message = FALSE, fig.align="center"}
egk_k

par(mar=c(0,0,0,0), oma=c(0,0,0,0))
plot(egk_k, box = FALSE, axes = FALSE)
```

Populations are represented as a stack of rasters that describes the total number of individuals that occur in each cell for each life-stage. In the kangaroo example data, there are three life-stages and thus three individual raster layers in the stack. The values are either zeros or positive integers. This example spatial data is available in the steps package ("egk_pop"), however, any raster stack can be used in its place.

```{r, message = FALSE, fig.align="center"}
egk_pop

par(mar=c(0,0,0,0), oma=c(0,0,0,0))
spplot(egk_pop)
```

All three of these spatial components define a "landscape" object, however, only the population data is required. The lanscape object is modified at each timestep in a single simulation based on habitat and population dynamics (described in subsequent sections below).

```{r, message = FALSE}
egk_landscape <- landscape(population = egk_pop,
                           suitability = NULL, # could also specify suitability (egk_hab) here
                           carrying_capacity = NULL) # could also specify carrying capacity (egk_k) here
```

These are the only data input requirements for a simple population simulation, however, we also need to specify population dynamics at a minimum. Dynamic functions are used to modify populations or habitats in a landscape at each timestep in a simulation. They can be selected as 'off-the-shelf' functions included in the 'steps' package or custom defined functions created by the user. In its most basic form, only population growth will be applied to the landscape. As shown in the following code, we pass in a predefined growth function - with a transition matrix - and leave all of the other parameters at their default values (NULL).

```{r, message = FALSE}
egk_pop_dynamics <- population_dynamics(change = growth(transition_matrix = egk_mat),
                                        dispersal = NULL,
                                        modification = NULL,
                                        density_dependence = NULL)
```

Now that we have constructed the landscape object and defined a dynamic object, we can run a single simulation (i.e replicates = 1, default). We simulate changes to the kangaroo population over twenty timesteps. Runtime will depend on the complexity of the landscape object and the configuration of the dynamic object(s).

```{r, message = FALSE,  results='hide', progress=FALSE}
egk_results <- simulation(landscape = egk_landscape,
                          population_dynamics = egk_pop_dynamics,
                          habitat_dynamics = NULL,
                          timesteps = 20,
                          replicates = 1,
                          verbose = FALSE)
```

Once a simulation has been run, we can plot temporally-explicit information.

For this example, we can view the kangaroo population trajectories of each life-stage:

```{r, message = FALSE, fig.align="center"}
plot(egk_results)
```

Or the total kangaroo population trajectory:

```{r, message = FALSE, fig.width=4, fig.align="center"}
plot(egk_results, stage = 0)
```

Or the kangaroo population trajectory for a single life-stage:

```{r, message = FALSE, fig.width=4, fig.align="center"}
plot(egk_results, stage = 2, newplot = TRUE)
```

We can also view the population distribution over the landscape for a single life-stage (only timesteps one through nine shown):

```{r, message = FALSE, fig.align="center"}
plot(egk_results, type = "raster", stage = 2)
```

We can also perform multiple simulations. For the kangaroo, we specified three replicates of a twenty timestep simulation. The replicates are run sequentially by default, however, to improve computation time, we have included the ability to run all three replicates in parallel - each on a different processor.

```{r, message = FALSE, echo = FALSE}

egk_results <- simulation(landscape = egk_landscape,
                          population_dynamics = egk_pop_dynamics,
                          habitat_dynamics = NULL,
                          timesteps = 20,
                          replicates = 3,
                          verbose = FALSE)
```

The default plot will show all of the simulation relicates and the mean population trajectory:

```{r, message = FALSE, fig.width=4, fig.align="center"}
plot(egk_results)
```

Because a simulation object is comprised of single or multiple replicates, we can subset and plot individual replicates. Here, we plot the population projections for the third replicate of the simulation:

```{r, message = FALSE, fig.width=4, fig.align="center"}
plot(egk_results[3], stage = 0)
```

Note, if several replicates of a simulation are run, you must explicitly specify which one to plot for rasters (i.e. egk_results[1])

```{r, message = FALSE, fig.align="center"}
plot(egk_results[1], type = "raster", stage = 2)
```

Note that the plots above look very similar to the single replicate simulation. This is because we have not added any major stochastic dynamics to the landscape (but demographic stochasticity IS on by default in the growth function). Let's try adding some globally acting environmental stochasticity to the growth function:

```{r, message = FALSE}
egk_pop_dynamics <- population_dynamics(change = growth(transition_matrix = egk_mat,
                                                        global_stochasticity = egk_mat_stoch),
                                        dispersal = NULL,
                                        modification = NULL,
                                        density_dependence = NULL)

egk_results <- simulation(landscape = egk_landscape,
                          population_dynamics = egk_pop_dynamics,
                          habitat_dynamics = NULL,
                          timesteps = 20,
                          replicates = 3,
                          verbose = FALSE)

plot(egk_results)
```

Now let's add some other population dynamics. We can specify a ceiling density dependence (population_cap function) but must provide a carrying capacity layer in the landscape for this to work. By default all life-stages contribute to density dependence, however, we specify the adults only - see the help for more information.

```{r, message = FALSE}
egk_landscape <- landscape(population = egk_pop,
                           suitability = NULL,
                           carrying_capacity = egk_k)

egk_pop_dynamics <- population_dynamics(change = growth(transition_matrix = egk_mat,
                                                        global_stochasticity = egk_mat_stoch),
                                        dispersal = NULL,
                                        modification = NULL,
                                        density_dependence = population_cap(stages = 3))

egk_results <- simulation(landscape = egk_landscape,
                          population_dynamics = egk_pop_dynamics,
                          habitat_dynamics = NULL,
                          timesteps = 20,
                          replicates = 3,
                          verbose = FALSE)

plot(egk_results)
```

The landscape object sub-components are stored for each timestep (if they are initially specified) so it is possible to also view the carrying capacity throughout a single simulation (i.e. egk_results[1]). Note, only timesteps one through nine are shown by default but this can be changed - see help for more information.

```{r, message = FALSE, fig.align="center"}
plot(egk_results[1], object = "carrying_capacity")
```

So far, the populations are only changing within their cells without any movement between cells. Let's add dispersal to allow kangaroos to move throughout the landscape. There are several dispersal functions and all of them utilise habitat suitability, carrying capacity, or both to determine arrival probabilities - see help for more information. Thus we will need to provide the approproate layer in the intial landscape. Below, we use kernel-based dispersal and habitat suitability to determine the arrival probabilities:

```{r, message = FALSE, progress = FALSE}
egk_landscape <- landscape(population = egk_pop,
                           suitability = egk_hab,
                           carrying_capacity = egk_k)

egk_pop_dynamics <- population_dynamics(change = growth(transition_matrix = egk_mat,
                                                        global_stochasticity = egk_mat_stoch),
                                        dispersal = kernel_dispersal(arrival_probability = "suitability"),
                                        modification = NULL,
                                        density_dependence = population_cap(stages = 3))

egk_results <- simulation(landscape = egk_landscape,
                          population_dynamics = egk_pop_dynamics,
                          habitat_dynamics = NULL,
                          timesteps = 20,
                          replicates = 3,
                          verbose = FALSE)

plot(egk_results)
```

Let's have a look at how the adult population is changing in the first repicate of the simulation:

```{r, message = FALSE, fig.align="center"}
plot(egk_results[1], type = "raster", stage = 3)
```

All of the rasters may also be plotted as animations - see help for more information.

So far the kangaroo population is the only thing to be dynamically changing in the landscape, however, often habitat suitability also changes due to disturbances. To characterise habitat disturbance, we can use a series of raster layers that map the locations and severity of fires. Each fire raster will be multiplied with the habitat suitability layer and thus contain values between zero (intense fire) and one (no fire). Note, the number of disturbance layers must match the intended number of timesteps in a single simulation. There is an existing spatial dataset of fires in the steps package ("egk_dist") which we store in the landscape object. We use a pre-defined disturbance function to modify the habitat suitability in the simulation at each timestep. The function requires an initial habitat suitability layer, the name of disturbance layers stored in the landscape object ("fires"), and an effect time which specifies the number of timesteps that each disturbance layer acts on the habitat suitability. In this example, we provide the kangaroo habitat suitability input ("egk_hab"), the kangaroo fire disturbance input name ("fires"), and an effect time of three - meaning each fire layer will affect the habitat suitability for three timestep in each simulation replicate. All functions that act on the habitat must be passed in as a list in the simulation call:

```{r, message = FALSE}
egk_landscape <- landscape(population = egk_pop,
                           suitability = egk_hab,
                           carrying_capacity = egk_k,
                           fires = egk_dist)

egk_pop_dynamics <- population_dynamics(change = growth(transition_matrix = egk_mat,
                                                        global_stochasticity = egk_mat_stoch),
                                        dispersal = kernel_dispersal(arrival_probability = "suitability",
                                                                     dispersal_proportion = 0.5),
                                        modification = NULL,
                                        density_dependence = population_cap(stages = 3))

egk_results <- simulation(landscape = egk_landscape,
                          population_dynamics = egk_pop_dynamics,
                          habitat_dynamics = list(disturbance(habitat_suitability = egk_hab,
                                                                    disturbance_layers = "fires",
                                                                    effect_time = 3)),
                          timesteps = 20,
                          replicates = 3,
                          verbose = FALSE)

plot(egk_results)
```

And now let's have a look at how the adult population is changing with fires occurring in the landscape:

```{r, message = FALSE, fig.align="center"}
plot(egk_results[1], type = "raster", stage = 3)
```

Since we are using habitat dynamics we may want to have a look at how the habitat suitability changes in a landscape. Similar to carrying capacity - as shown earlier - it is possible to view the habitat suitability throughout a single simulation:

```{r, message = FALSE, fig.align="center"}
plot(egk_results[1], object = "suitability")
```